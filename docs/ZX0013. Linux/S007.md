# a. 安装过程梳理

更新日期：2020-07-12

--------------------------------------

# 1. 概述

Arch的安装过程比较麻烦，虽然WiKi上有详细的步骤说明，但是还是经常容易出现失误。
所以我这里整理了一些安装过程，便于以后需要安装的时候和WiKi配合使用。

# 2. 准备工作

安装Arch必须要具备的条件是：

- U盘。用来装Live系统。
- 网络连接。用来装包。

Live系统是必备的。安装过程中出现失误的话可以使用Live系统来修复，不用从头再来。在后面的使用过程中如果出现系统不能启动的问题也能使用Live系统来修复。

一个快速的网络会有更好的安装体验，因为要下载GB单位的数据。

# 3. 主要步骤

在开始安装之前，要说明的一点是，Linux可以被安装在U盘上或者是移动硬盘上。这样的好处显而易见，我拿着一个很小的移动硬盘到处走，插在不同的电脑上开机使用，可以直接进入平时自己一直在使用的最熟悉的系统。

这样的一个系统不是Live系统，而是一个真正可以日常使用的系统。

如果想安装这样的一个系统。建议先按照正常的流程安装在移动硬盘上。在全部配置完成后进行调整，以使它能在不同的硬件上正常启动。

一个正常的安装流程主要有下面这些步骤。步骤的顺序并不完全和WiKi上的一模一样，其实是没有那么严格的顺序的。

- 1 制作Live系统。如果已经有了就不用做了。
- 2 启动到Live系统。
- 3 配置Live环境。(网络连接、时间同步等)
- 4 硬盘分区。
- 5 挂载分区。
- 6 安装新系统的基本组件。
- 7 切换到新系统。
- 8 配置新系统的环境。(时区、字符集、密码等)
- 9 在新系统中安装必备的基础软件。(如连接WiFi的软件)
- 10 安装引导程序。
- 11 启动到新系统。
- 12 连接网络。
- 13 配置用户。
- 14 安装基本组件。(如微码、防火墙等)

这样一个新的系统就安装完毕了。但它默认是没有图形界面环境的。
如果要使用桌面环境，则还需要下面这些步骤。

- 1 安装Xorg。
- 2 安装显卡驱动。
- 3 安装显示管理器。(登录界面)
- 4 安装桌面环境或者窗口管理器。
- 5 安装终端程序。
- 6 安装中文字体。

# 4. 细节

这里就对上面列出的每个步骤进行详述。

首先是基本安装步骤。

<u>__1 制作Live系统。如果已经有了就不用做了。__</u>

这一步不用细说了，完全按照WiKi上的方法安装就可以。

<u>__2 启动到Live系统。__</u>

开启启动时选择从U盘启动。
要注意的是Surface这样的设备比较特殊，要关闭安全启动才行，而且即使启动成功连无法联网。Surface的问题我们以后再说。

<u>__3 配置Live环境。(网络连接、时间同步等)__</u>

启动后会进入Live系统的命令行界面。为了后面的工作能顺利进行，这里需要进行一些基本的配置工作。

A. 首先是配置键盘布局。

因为如果键盘布局不对，我们输入各种符号的时候会非常麻烦，甚至有些符号敲不出来，严重影响我们后面的安装过程。

以日语键盘为例。

```bash
loadkeys jp106
```

B. 然后说一说网络连接。

由于我们要联网下载一些包。所以网络是必须的。

以网线直连和连接WiFI两种方式分别说明。

!!! example "网线直连"

    查看网络接口：

    ```bash
    ip link
    ```

    可能的输出如下:

    ```bash
    [hakureiyoumu@archlinux ~]$ ip link
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    2: enp1s0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
        link/ether 98:ee:cb:a5:ac:e6 brd ff:ff:ff:ff:ff:ff
    3: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DORMANT group default qlen 1000
        link/ether c8:b4:22:3b:c2:21 brd ff:ff:ff:ff:ff:ff

    ```

    让我们假定途中`enp1s0`就是主板上网卡的接口。如果后面的尖括号`<>`中有`UP`的字样，则表示这个接口以及启动了。如果没有则用下面的命令来打开。

    ```bash
    ip link set enp1s0 up
    ```

    此时应该以及连接上网络了，但通常我们还需要打开动态IP服务获取动态IP地址后才能真正开始使用。用下面这个命令。

    ```bash
    dhcpcd
    ```

    命令执行成功后会自动切到后台去运行。

    这时应该已经连接成功了。使用如下命令来验证连接是否成功。

    ```bash
    ping www.bing.com
    ```

!!! example "连接WiFi"

    在最新的Arch Live系统中，已经安装好了用来进行WiFi连接的图形节目工具`wifi-menu`。我们可以用这个来连接，再也不用敲很复杂的命令了。

    但是要使用`wifi-menu`，我们必须要先关闭网络接口，不然会用不了。

    查看网络接口：

    ```bash
    ip link
    ```

    可能的输出如下:

    ```bash
    [hakureiyoumu@archlinux ~]$ ip link
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    2: enp1s0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
        link/ether 98:ee:cb:a5:ac:e6 brd ff:ff:ff:ff:ff:ff
    3: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DORMANT group default qlen 1000
        link/ether c8:b4:22:3b:c2:21 brd ff:ff:ff:ff:ff:ff

    ```

    假定`wlan0`就是我们的无线网卡接口。使用如下命令来关闭：

    ```bash
    ip link set wlan0 down
    ```

    然后启动`wifi-menu`:

    ```bash
    wifi-menu
    ```

    按照图形节目上的提示来完成连接相信并不难。

    最后仍然需要启动动态IP服务来获得动态IP地址。

    ```bash
    dhcpcd
    ```

    命令执行成功后会自动切到后台去运行。

    这时应该已经连接成功了。使用如下命令来验证连接是否成功。

    ```bash
    ping www.bing.com
    ```

C. 同步系统时间

使用如下命令即可：

```bash
timedatectl set-ntp true
```

<u>__4 硬盘分区。__</u>

相信在决定安装新的操作系统的时候，你一定已经规划好了如果使用硬盘。

<u>首先是验证启动模式</u>

这个步骤是为了验证你的主板是否支持UEFI启动。

```bash
ls /sys/firmware/efi/efivars
```

如果结果里有内容说明是支持的。

<u>分区</u>

查看磁盘信息：

```bash
lsblk
```

找到要使用的那个磁盘，后面用的时候千万别输错了。

进入分区模式：(假设那个磁盘是sdx)

```bash
fdisk /dev/sdx
```

这个工具带有帮助手册，按照提示进行操作即可。常用的操作有：

- g 创建GPT类型的分区表
- n 创建新的分区

注意如果是采用UEFI方式，则至少要创建如下所示的两个分区。

```bash
/dev/sdx1   512M        EFI FileSystem
/dev/sdx2   238G        Linux FileSystem
```

<u>格式化分区</u>

对于EFI分区，要格式化成`FAT32`文件系统。

```bash
mkfs.fat -F32 /dev/sdx1
```

其它的分区，统一使用`Ext4`文件系统即可。

```bash
mkfs.ext4 /dev/sdx2
```

如果这个分区是在SSD磁盘上，则最好使用不带日志系统的文件系统。

```bash
mkfs.ext4 -O "^has_journal" /dev/sdx2
```

<u>__5 挂载分区。__</u>

以UEFI为例。我们要挂载主分区和EFI分区。

挂载主分区：

```bash
mount /dev/sdx2 /mnt
```

创建EFI分区的挂载点：

```bash
mkdir -p /mnt/esp
```

名字可以不叫`esp`，随便起，后面用的时候别忘记了。

挂载EFI分区：

```bash
mount /dev/sdx1 /mnt/esp
```

<u>__6 安装新系统的基本组件。__</u>

先选择镜像源。不同的源速度可以差异比较大。选择较快的源自然会有更好的安装体验。

修改下面这个文件即可，通常挑选地理位置比较近的就可以。

```bash
/etc/pacman.d/mirrorlist
```

然后可以安装基本组件了。

pacstrap /mnt base linux linux-firmware

base是linux的基础包，里面有各种基本小组件。linux为内核。linux-firmware为驱动。

然后要生成fstab文件：

```bash
genfstab -U /mnt >> /mnt/etc/fstab
```

生成完了之后，别忘了看一下生成的fstab文件的内容是否正确。

fstab文件示例：

```bash
# Static information about the filesystems.
# See fstab(5) for details.

# <file system> <dir> <type> <options> <dump> <pass>
# /dev/sdb2
UUID=374a6b7d-07e9-4a61-9cb3-e69ca0207061       /               ext4            rw,relatime     0 1

# /dev/sdb1
UUID=3263-E4C1          /esp            vfat            rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,utf8,errors=remount-ro       0 2
```

看看自己的分区是不是都在里面了。

<u>__7 切换到新系统。__</u>

使用如下命令切换到新系统：

```bash
arch-chroot /mnt
```

切换之后，你所做的一切操作都相当于在新的系统中操作的。

<u>__8 配置新系统的环境。(时区、字符集、密码等)__</u>

A. 配置时区

例如上海就是：

```bash
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
```

东京就是：

```bash
ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
```

不知道城市的名字怎么拼的时候，可以从下面这个目录一步一步找：

```bash
/usr/share/zoneinfo
```

然后我们使用下面这个命令来根据时区同步时钟：

```bash
hwclock --systohc
```

B. 本地化

编辑下面这个文件，放开常用字符集的注释：

```bash
/etc/locale.gen
```

执行 locale-gen 以重新生成 locale 讯息：

```bash
locale-gen
```

创建下面这个文件，并制定字符集。

```bash
/etc/locale.conf

LANG=en_US.UTF-8
```

编辑如下文件来使键盘布局永久生效。同样以日文键盘布局为例：

```bash
/etc/vconsole.conf

KEYMAP=jp106
```

C. 配置host文件

编辑host文件，往里面添加本机信息。

```bash
/etc/hosts

127.0.0.1	localhost
::1		localhost
```

D. 设置root用户密码

执行下面的命令进行设置：

```bash
passwd
```

<u>__9 在新系统中安装必备的基础软件。(如连接WiFi的软件)__</u>

为了避免我们启动到新系统之后没有软件可用，可以在这里安装一些实用的小工具。

- 文本编辑器：vim vi
- 网络连接：netctl dhcpcd dialog wpa_supplicant
- 磁盘分区格式化工具：dosfstools
- 下载工具：wget
- 解压缩：unzip
- 基础包组：base-devel

只要安装了网络连接包，这些都可以启动到新系统后再安装。

<u>__10 安装引导程序。__</u>

以最常见的grub为例吧。

先安装下面的两个软件包：

- grub
- efibootmgr

创建存放引导程序的目录：

```bash
mkdir /esp
```

挂载EFI分区：

```bash
mount /dev/sdx1 /esp
```

安装grub引导程序：

```bash
grub-install --target=x86_64-efi --efi-directory=/esp --bootloader-id=GRUB
```

生成配置文件：

```bash
grub-mkconfig -o /boot/grub/grub.cfg
```

大功告成。

<u>__11 启动到新系统。__</u>

现在可以重启电脑了。记得拔下Live系统的U盘。

启动后进入控制台界面，和Live系统是一样的。只不过需要输入用户名和密码才能登陆。此时只有一个用户可以，输入`root`和上面自己设定的密码进行登录。

<u>__12 连接网络。__</u>

按照和Live系统中同样的方法连接网络。

<u>__13 配置用户。__</u>

创建新的用户：

```bash
useradd -m youruser 
```

修改新用户的密码：

```bash
passwd youruser
```

加入sudo组，这样这个用户就可以通过执行`sudo`命令来提升权限了：

```bash
groupadd sudo
usermod -a -G sudo youruser
```

但是要先设在sudo组的权限才行。使用`visudo`命令编辑对应的配置文件，去掉sudo前面的注释。

```bash
visudo

## Uncomment to allow members of group sudo to execute any command
%sudo   ALL=(ALL) ALL
```

<u>__14 安装基本组件。(如微码、防火墙等)__</u>

先说微码，依次安装下面这些软件即可：

- amd-ucode
- intel-ucode

安装完后更新grub的配置：

```bash
grub-mkconfig -o /boot/grub/grub.cfg
```

防火墙和SSH则需要安装如下软件包：

- firewalld
- sshd

安装完后设置为开机启动：

```bash
systemctl enable firewalld
systemctl enable sshd
```

下面介绍安装桌面环境的额外步骤：

<u>__1 安装Xorg。__</u>

安装如下软件包即可：

- xorg

<u>__2 安装显卡驱动。__</u>

根据显卡或者CPU的厂商来选择安装：

- xf86-video-intel              // Intel核显
- xf86-video-ati                 // AMD核显或者独立显卡
- xf86-video-nouveau      // 英伟达独立显卡

<u>__3 安装显示管理器。(登录界面)__</u>

随便从WiKi上选一个，这里我用的是sddm：

- sddm

设置为开机启动：

```bash
systemctl enable sddm
```

现在千万不要着急重启，由于没有安装桌面环境。重启后会直接进入登录画面，但是又登录不进去，只能切换到另一个tty在控制台界面中进行修复了。

<u>__4 安装桌面环境或者窗口管理器。__</u>

这里选择安装KDE桌面。窗口管理器比较轻量级，但需要花费你大量的精力去配置。

可以安装如下两个包来安装KDE全家桶：

- plasma
- kde-applications

一旦安装了桌面包之后，显示管理器如sddm就可以检测到它们，并不需要特别做什么配置。

<u>__5 安装终端程序。__</u>

如果是安装了KDE这样的全家桶，那肯定会自带终端。则这里就不用再安装了。

如果是安装的窗口管理器，则最好安装一个终端，并配置为窗口管理器的默认终端。
这样可以避免重启进入窗口管理器之后由于配置失误需要在终端中修改配置时却没有终端程序的尴尬。

推荐的终端程序是这个：

- tilda

可以设置下拉效果和半透明效果。

<u>__6 安装中文字体。__</u>

只需要安装下面这个字体包：

- wqy-microhei

现在你可以将系统语言设置为中文了。

# 5. 使系统可以在其他硬件上启动

我们把Arch安装到移动硬盘或U盘之后，它只能在你安装的这台硬件上启动。当然我们是有办法让它在任何一个电脑上启动的。

我们只要做下面这几件事情就可以了。

<u>__安装尽可能多的硬件驱动__</u>

比如显卡的驱动。把AMD、Intel和英伟达的都给装了。

<u>__设置硬件自动检测__</u>

编辑下面的文件，将 block 和 keyboard 钩子移动到 autodetect 前面。这样系统才可以检测到不同的硬件配置。

```bash
/etc/mkinitcpio.conf

##   NOTE: If you have /usr on a separate partition, you MUST include the
#    usr, fsck and shutdown hooks.
HOOKS=(base udev block keyboard  autodetect modconf filesystems fsck)
```

然后我们更新系统：

```bash
sudo pacman -Syu
```

<u>__安装grub为可移动模式__</u>

```bash
grub-install --target=x86_64-efi --efi-directory=/esp  --removable --recheck
```

<u>__检验成果__</u>

现在关机然后把移动硬盘插到另外一台电脑上。你会发现可能正常识别到系统了，启动后会是自最自己配置好的熟悉的界面。