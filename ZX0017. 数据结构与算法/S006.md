# 17.6 红黑树（2）- 基本原理

更新日期：2020/06/30

-------------------

## 1. 概述

在学习红黑树的时候，我阅读了包括WiKi百科在内的很多介绍性文章。但是看了一篇又一篇之后，我仍然是一头雾水。

有各种各样的情形，有旋转颜色反转等花式操作。我们的确可能记住了每一种情形应该做什么操作，但过一段时间之后我们估计就全忘记了。主要是它背后的思想没有搞懂，正所谓知其然不知其所以然。

在本章我就试图理一理红黑树背后的思想。

## 2. 红黑树与二叉树

红黑树是一种特殊的排序二叉树。也就是说它满足所有排序二叉树的性质，所有二叉树的操作它都可以做。

而实际上，红黑树的各种操作正是建立在二叉树操作的基础之上。比如插入元素、删除元素这些操作。就是先按照普通排序二叉树的方法进行操作。然后再通过各种调整手段使其满足红黑树不同于普通二叉树的特殊性质。在用具体代码实现红黑树的操作时，基本都是这么个步骤。

{% dot attack_plan.svg
digraph {
    node [shape=box]
    edge [arrowhead=vee]

    1 [label="按排序二叉树的规则插入元素", width=3]
    2 [label="调整二叉树使其满足红黑树的性质"]
    3 [label="按排序二叉树的规则删除元素", width=3]
    4 [label="调整二叉树使其满足红黑树的性质"]

    1 -> 2
    3 -> 4
}
%}

我们在各种教程上看到的步骤都是在讲调整二叉树。因此在学习红黑树之前，我们应该复习一遍二叉树。

## 3. 红与黑到底代表了什么

刚开始接触红黑树时，容易被这个颜色搞糊涂。这个颜色标记自然是有其作用的。注意我说了 __标记__ 这个词，给节点涂上颜色自然是在作一种记号，也就是说黑色节点和红色节点是有所不同。

我先说我个人看法的结论: ___同一个节点的红色子节点所在的路径比黑色子节点所在的路径深度要多1___

更通俗一点的说法，如果节点具有重量的话，就是红色节点的那一层比较重，子结点较多。

还是看先前那棵二叉树:

{% dot attack_plan.svg
digraph G { 

    node [shape=circle, width=0.5, fixedsize=true]
    nodesep=0.3
    edge[arrowhead=vee]

    // 如果是红黑树，则设置所有节点为红色
    node [style=filled, fillcolor="#AA0000", fontcolor=white]

    // 定义图的节点，"n"开头的为占位节点
    // lv1
    54
    // lv2
    33 n54 556
    // lv3
    3 n33 45
    67 n556 2423
    // lv4
    1 n3 4
    55 n67 99
    2345 n2423 6666
    // lv5
    98 n99 100

    // 设置父子关系
    // lv1 -> lv2
    54 -> 33, 556
    // lv2 -> lv3
    33 -> 3, 45
    556 -> 67, 2423
    // lv3 -> lv4
    3 -> 1, 4
    67 -> 55, 99
    2423 -> 2345, 6666
    // lv4 -> lv5
    99 -> 98, 100

    // 连接父节点与占位节点，并将连接线设置为隐藏
    54 -> n54 [style=invis]
    33 -> n33 [style=invis]
    556 -> n556 [style=invis]
    3 -> n3 [style=invis]
    67 -> n67 [style=invis]
    2423 -> n2423 [style=invis]
    99 -> n99 [style=invis]

    // 占位节点设置为隐藏
    n54, n33, n556, n3, n67, n2423, n99 [width=0, height=0, style=invis]

    // 将父节点与占位节点设置为同一个组，使其在竖直方向上对齐
    54, n54 [group=n54]
    33, n33 [group=n33]
    556, n556 [group=n556]
    3, n3 [group=n3]
    67, n67 [group=n67]
    2423, n2423 [group=n2423]
    99, n99 [group=n99]

    // 如果是红黑树，则设置黑色节点的颜色
    54, 33, 556, 3, 45, 2423, 55, 99 [style=filled, fillcolor=black, fontcolor=white]

    a [label="看这个节点", shape=none, style=none, fontcolor=blue]
    a -> 67 [color=blue]
} 
%}

注意比较节点 __67__ 和同一层的其他节点，比如节点 __2423__，你会发现 __67__ 那一层多了一层子节点。这是由红黑树的性质决定的，因为每条路径上的黑色节点必须是一样的，每多一个红色节点，这条路径自然就深了一层。

可以说，红黑树调整的所有操作都是基于这一点。

## 4. 所谓的5条规则

红黑树的5条规则，是对红黑树添加一些限制，使其逐渐平衡。各个规则可能要组合起来看才能看出端倪。

再来看一遍这5条规则:

- (1) 节点是红色或黑色。
- (2) 根是黑色。
- (3) 所有叶子都是黑色（叶子是NIL节点）。
- (4) 每个红色节点必须有两个黑色的子节点。（从每个叶子到根的所有路径上不能有两个连续的红色节点。）
- (5) 从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。

这里面真正重要并且起关键作用的是4和5。规则123更多的是一中约定俗成的东西，主要为了描述规则4和5时能更方便，更容易描述清楚。也就是在给它们铺路。

而规则4和5一起保证了红黑树的一个最重要的特性：__任何路径都不能多于任何其他路径的两倍长__

所谓两倍长，是一种极端情况，有多极端呢？看看下面这图。

{% dot attack_plan.svg
digraph G { 

    node [shape=circle, width=0.5, fixedsize=true]
    nodesep=0.3
    edge[arrowhead=vee]

    // 如果是红黑树，则设置所有节点为红色
    node [style=filled, fillcolor="#AA0000", fontcolor=white]

    // 定义图的节点，"n"开头的为占位节点
    // lv1
    50
    // lv2
    33 n50 556
    // lv3
    3 n33 45
    67 n556 2423
    // lv4
    55 n67 99
    2345 n2423 6666
    // lv5
    51 n55 56
    98 n99 100
    2344 n2345 2346
    6000 n6666 7000
    n56 57
    5000 n6000 6500

    // 设置父子关系
    // lv1 -> lv2
    50 -> 33, 556
    // lv2 -> lv3
    33 -> 3, 45
    556 -> 67, 2423
    // lv3 -> lv4
    67 -> 55, 99
    2423 -> 2345, 6666
    // lv4 -> lv5
    55 -> 51, 56
    99 -> 98, 100
    2345 -> 2344, 2346
    6666 -> 6000, 7000
    56 -> 57
    6000 -> 5000, 6500

    // 连接父节点与占位节点，并将连接线设置为隐藏
    50 -> n50 [style=invis]
    33 -> n33 [style=invis]
    556 -> n556 [style=invis]
    3 -> n3 [style=invis]
    67 -> n67 [style=invis]
    2423 -> n2423 [style=invis]
    99 -> n99 [style=invis]
    55 -> n55 [style=invis]
    2345 -> n2345 [style=invis]
    6666 -> n6666 [style=invis]
    56 -> n56 [style=invis]
    6000 -> n6000 [style=invis]

    // 占位节点设置为隐藏
    n50, n33, n556, n3, n67, n2423, n55, n99, n2345, n6666, n56, n6000 [width=0, height=0, style=invis]

    // 将父节点与占位节点设置为同一个组，使其在竖直方向上对齐
    50, n50 [group=n54]
    33, n33 [group=n33]
    556, n556 [group=n556]
    3, n3 [group=n3]
    67, n67 [group=n67]
    2423, n2423 [group=n2423]
    99, n99 [group=n99]
    55, n55 [group=n55]
    2345, n2345 [group=n2345]
    6666, n6666 [group=n6666]
    56, n56 [group=n56]
    6000, n6000 [group=n6000]

    // 如果是红黑树，则设置黑色节点的颜色
    50, 33, 67, 3, 45, 2423, 51, 56, 98, 100, 2344, 2346, 6000, 7000 [style=filled, fillcolor=black, fontcolor=white]
} 
%}

图中的最短路径为连续3个黑色节点。最长路径为红黑间隔的 3 + 3 共6个节点。

其实可以看到，即便是这种非常极端的情况，整体来说还是比较平衡的。
